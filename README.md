# System Design социальной сети для курса по System Design
## 1. Требования
### 1. Бизнес требования
Есть неограниченный бюджет для продвижения социальной сети.
Бизнес ограничение - не рассматриваем выход на зарубежные рынки за пределами стран СНГ.

### 1. Функциональные требования
Система должен включать в себя следующие возможности:
- публикация постов из путешествий. Посты включают с себя:
  - фотографии
  - небольшое описание
  - привязка к конкретному месту путешествия (геопозиция);
- оценка постов других путешественников;
- комментарии постов других путешественников;
- подписка на других путешественников, чтобы следить за их активностью;
- поиск популярных мест для путешествий и просмотр постов с этих мест;
- просмотр ленты других путешественников;


### 1. Нефункциональные требования
Система должна иметь следующие свойства:

| **Атрибут**            | **Идентификатор** | **Описание**                                                                                                                                                                                            |
|------------------------|-------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Производительность     | PFR-001           | Время загрузки поста с фотографией по 99п не должно превышать 2 секунды. По 99.9п не должно превышать 3 секунд. Время загрузки должно обеспечиваться при скорости связи не менее 10 мегабит в сек.      |
| Производительность     | PFR-002           | Время успешной публикации комментариев к постам по 99 п не должно превышать 1 секунды. По 99.9п не должно превышать 2 секунд. Время должно обеспечиваться при скорости связи не менее 10 мегабит в сек. |
| Производительность     | PFR-003           | Время для просмотра ленты других путешественников должно быть аналогично требованию PFR-001                                                                                                             |
| Производительность     | PFR-004           | Время для поиска популярных мест для путешествий и просмотр постов с этих мест должно быть аналогично требованию PFR-001                                                                                |
| Производительность     | PFR-005           | Один пользователь в среднем будет оставлять 5 постов в день                                                                                                                                             |
| Производительность     | PFR-006           | Один пользователь в среднем будет смотреть ленту других путешественников 3 раза в день                                                                                                                  |
| Производительность     | PFR-007           | Один пользователь в среднем будет искать популярные места 1 раз в день                                                                                                                                  |
| Производительность     | PFR-008           | Один пользователь в среднем будет подписываться на других путешественников 1 раз в день                                                                                                                 |
| Производительность     | PFR-009           | Один пользователь в среднем будет комментировать и ставить реакцию на посты 1 раз в день                                                                                                                |
| Производительность     | PFR-010           | Размер фото не должен превышать 1 мегабайт. Если размер превышает, то сжимаем до 200 кбайт                                                                                                              |
| Производительность     | PFR-011           | Размер одного поста без фото должен быть не более 2000 символов, аналогично размер комментария                                                                                                          |
| Масштабируемость       | SCL-001           | Число активных уникальных пользователей в день через 1 год должно составить 10 000 000. Средний рост составляет примерно 840 000 в месяц                                                                |
| Доступность            | AVL-001           | Система должна быть доступна в 99.9% времени за месяц                                                                                                                                                   |
| Безопасность           | SEC-001           | Персональные данные клиентов не должны отдаваться в ответах от методов.                                                                                                                                 |
| Безопасность           | SEC-002           | Должна быть защита от ddos атак. При запросах от одного клиенского устройства чаще 10 RPS на каждый метод в отдельности производим блокировку пользователя на 60 минут                                  | |
| Совместимость          | CPB-001           | Система должна поддеживать работы на мобильных приложения IOS (версии не ниже), Android (версии не ниже), на вебе Google Chrome (версии не ниже)                                                        |
| Удобство использования | USL-001           | Интерфейс системы должен быть на русском языке                                                                                                                                                          |

## 2. Прогнозируемая нагрузка
### Динамика роста пользователей:

| **Месяц**           | **1 месяц** | **2 месяц** | **3 месяц** | **4 месяц** | **5 месяц** | **6 месяц** | **7 месяц** | **8 месяц** | **9 месяц** | **10 месяц** | **11 месяц** | **12 месяц** |
|---------------------|-------------|-------------|-------------|-------------|-------------|-------------|-------------|-------------|-------------|--------------|--------------|--------------|
| Рост пользователей  | 840 000     | 1 680 000   | 2 520 000   | 3 360 000   | 4 200 000   | 5 040 000   | 5 880 000   | 6 720 000   | 7 560 000   | 8 400 000    | 9 240 000    | 10 000 000   |

Каждый месяц рост на 820 000 пользователей. К году рост достигнет 10 000 000 уникальный пользователей в день.


### Прогноз количества запросов:

| **Среднее число запросов на 1 пользователя** | **avg_requests (в сутки)** | **avg_requests (в секундах)** |
|----------------------------------------------|----------------------------|-------------------------------|
| Добавление постов                            | 5                          | 5,78704E-05                   |
| Реакции на посты                             | 1                          | 1,15741E-05                   |
| Комментарии постов                           | 1                          | 1,15741E-05                   |
| Просмотр ленты постов                        | 3                          | 3,47222E-05                   |
| Поиск популярных мест                        | 1                          | 1,15741E-05                   |
| Просмотр ленты других путешественников       | 3                          | 3,47222E-05                   |
| Подписка ну путешественников                 | 1                          | 3,47222E-05                   |


### Прогноз нагрузки в RPS:

| Бизнес контекст                        | 1 год |
|----------------------------------------|-------|
| Добавление постов                      | 579   |
| Реакции на посты                       | 116   |
| Комментарии постов                     | 116   |
| Просмотр ленты постов                  | 347   |
| Поиск популярных мест                  | 116   |
| Просмотр ленты других путешественников | 347   |
| Подписка ну путешественников           | 16    |

Кол-во уникальный пользователей по динамике * avg_requests (в секундах).


### Прогноз трафика:
Средний размер запроса:

| Контекст                               | Байты    | Килобайты |
|----------------------------------------|----------|-----------|
| Добавление постов (фото)               | 200000   | 200       |
| Добавление постов (мета)               | 2200     | 2,2       |
| Добавление постов всего                | 202200   | 202,2     |
| Реакции на посты                       | 200      | 0,2       |
| Комментарии постов                     | 2200     | 2,2       |
| Просмотр ленты постов                  | 2022000  | 2022      |
| Поиск популярных мест                  | 2022000  | 2022      |
| Просмотр ленты других путешественников | 2022000  | 2022      |
| Подписка на путешественников           | 200      | 0,2       |

Расчет трафика (килобайты в секунду):

| Контекст                               | 1 год   |
|----------------------------------------|---------|
| Добавление постов (фото)               | 120 000 |
| Добавление постов (мета)               | 300     |
| Добавление постов (всего)              | 120 000 |
| Реакции на посты                       | 30      |
| Комментарии постов                     | 300     |
| Просмотр ленты постов                  | 700 000 |
| Поиск популярных мест                  | 250 000 |
| Просмотр ленты других путешественников | 700 000 |
| Подписка на путешественников           | 30      |

Расчет трафика (мегабайты в секунду):

| Контекст                               | 12 месяц |
|----------------------------------------|----------|
| Добавление постов (фото)               | 120      |
| Добавление постов (мета)               | 0.3      |
| Добавление постов (всего)              | 120      |
| Реакции на посты                       | 0,03     |
| Комментарии постов                     | 0.3      |
| Просмотр ленты постов                  | 700      |
| Поиск популярных мест                  | 250      |
| Просмотр ленты других путешественников | 700      |
| Подписка на путешественников           | 0,03     |

### Расчет одновременных соединений

| **Месяц**         | **12 месяц** |
|-------------------|--------------|
| Кол-во соединений | 1 000 000    |


## Расчет жесткого диска

Средние параметры:

| Параметр                        | HDD      | SSD (SATA) | SSD (nVME) |
|---------------------------------|----------|------------|------------|
| Объем                           | до 32ТБ  | до 100ТБ   | до 30ТБ    |
| Операции ввода-вывода в секунду | 100      | 1000       | 10000      |
| Пропускная способность          | 100 МБ/с | 500 МБ/с   | 3 ГБ/с     |

**Методика**
Disks_for_capacity = capacity / disk_capacity

Disks_for_throughput = traffic_per_second / disk_throughput

Disks_for_iops = iops / disk_iops

Disks = max(ceil(Disks_for_capacity), ceil(Disks_for_throughput), ceil(Disks_for_iops))

Где:

capacity - суммарный объем данных, которое необходимо хранить

disk_capacity - объем одного диска

traffic_per_second - суммарный трафик на запись/чтение в секунду

disk_throughput - пропускная способность одного диска

iops - суммарное количество запросов в секунду

disk_iops - количество операций ввода-вывод диска в секунду

ceil - функция округления вверх до целого числа

| Контест                                 | capacity | disk_capacity | Disks_for_capacity | traffic_per_second | disk_throughput | Disks_for_throughput | iops   | disk_iops | Disks_for_iops |
|-----------------------------------------|----------|---------------|--------------------|--------------------|-----------------|----------------------|--------|-----------|----------------|
| Добавление постов мета                  | 8,03     | 8,00          | 1,00               | 117,01             | 500,00          | 0,23                 | 578,70 | 1 000,00  | 0,58           |
| Добавление постов фото                  | 3650     | 30            | 122                | 117,01             | 500,00          | 0,23                 | 578,70 | 1 000,00  | 0,58           |
| Подписка на путешественников            | 0,73     | 1,00          | 0,73               | 0,02               | 500,00          | 0,00                 | 115,74 | 1 000,00  | 0,12           |
| Реакции на посты                        | 0,73     | 1,00          | 0,73               | 0,02               | 500,00          | 0,00                 | 115,74 | 1 000,00  | 0,12           |
| Комментарии постов                      | 8,03     | 8,00          | 1,00               | 0,25               | 500,00          | 0,00                 | 115,74 | 1 000,00  | 0,12           |
| Просмотр ленты постов                   | -        | -             | -                  | 700                | 500,00          | 0,00                 | 350    | 1 000,00  | 0,35           |
| Поиск популярных мест                   | -        | -             | -                  | 250                | 500,00          | 0,00                 | 150    | 1 000,00  | 0,12           |
| Просмотр ленты других путешественников  | -        | -             | -                  | 700                | 500,00          | 0,00                 | 350    | 1 000,00  | 0,35           |


На основании расчета принято решение использовать один SSD (SATA) объемом 16 терабайт для хранения всех объектов, кроме фото. Есть вероятность, что для постов потребуется диск SSD (nVME) из-за трафика.

Расчет производился исходя из показателей на конец первого года, в связи с чем реальное число запросов и трафик будет ниже, поскольку не учитывалась динамика роста трафика, а сразу учитывался конечный объем трафика.

capacity для добавления постов рассчитывалась исходя из мета информации о посте, без учета хранения самой картинки. 

Саму картинку предполагаю хранить на отдельных источниках хранения (возможно S3) или иной вариант. 
