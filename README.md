# System Design социальной сети для курса по System Design
## 1. Требования
### 1. Бизнес требования
Есть неограниченный бюджет для продвижения социальной сети.
Бизнес ограничение - не рассматриваем выход на зарубежные рынки за пределами стран СНГ.

### 1. Функциональные требования
Система должен включать в себя следующие возможности:
- публикация постов из путешествий. Посты включают с себя:
  - фотографии
  - небольшое описание
  - привязка к конкретному месту путешествия (геопозиция);
- оценка постов других путешественников;
- комментарии постов других путешественников;
- подписка на других путешественников, чтобы следить за их активностью;
- поиск популярных мест для путешествий и просмотр постов с этих мест;
- просмотр ленты других путешественников;


### 1. Нефункциональные требования
Система должна иметь следующие свойства:

| **Атрибут**            | **Идентификатор** | **Описание**                                                                                                                                                                                            |
|------------------------|-------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| Производительность     | PFR-001           | Время загрузки поста с фотографией по 99п не должно превышать 2 секунды. По 99.9п не должно превышать 3 секунд. Время загрузки должно обеспечиваться при скорости связи не менее 10 мегабит в сек.      |
| Производительность     | PFR-002           | Время успешной публикации комментариев к постам по 99 п не должно превышать 1 секунды. По 99.9п не должно превышать 2 секунд. Время должно обеспечиваться при скорости связи не менее 10 мегабит в сек. |
| Производительность     | PFR-003           | Время для просмотра ленты других путешественников должно быть аналогично требованию PFR-001                                                                                                             |
| Производительность     | PFR-004           | Время для поиска популярных мест для путешествий и просмотр постов с этих мест должно быть аналогично требованию PFR-001                                                                                |
| Производительность     | PFR-005           | Один пользователь в среднем будет оставлять 5 постов в день                                                                                                                                             |
| Производительность     | PFR-006           | Один пользователь в среднем будет смотреть ленту других путешественников 3 раза в день                                                                                                                  |
| Производительность     | PFR-007           | Один пользователь в среднем будет искать популярные места 1 раз в день                                                                                                                                  |
| Производительность     | PFR-008           | Один пользователь в среднем будет подписываться на других путешественников 1 раз в день                                                                                                                 |
| Производительность     | PFR-009           | Один пользователь в среднем будет комментировать и ставить реакцию на посты 1 раз в день                                                                                                                |
| Производительность     | PFR-010           | Размер фото не должен превышать 1 мегабайт. Если размер превышает, то сжимаем до 200 кбайт                                                                                                              |
| Производительность     | PFR-011           | Размер одного поста без фото должен быть не более 2000 символов, аналогично размер комментария                                                                                                          |
| Масштабируемость       | SCL-001           | Число активных уникальных пользователей в день через 1 год должно составить 10 000 000. Средний рост составляет примерно 840 000 в месяц                                                                |
| Доступность            | AVL-001           | Система должна быть доступна в 99.9% времени за месяц                                                                                                                                                   |
| Безопасность           | SEC-001           | Персональные данные клиентов не должны отдаваться в ответах от методов.                                                                                                                                 |
| Безопасность           | SEC-002           | Должна быть защита от ddos атак. При запросах от одного клиенского устройства чаще 10 RPS на каждый метод в отдельности производим блокировку пользователя на 60 минут                                  | |
| Совместимость          | CPB-001           | Система должна поддеживать работы на мобильных приложения IOS (версии не ниже), Android (версии не ниже), на вебе Google Chrome (версии не ниже)                                                        |
| Удобство использования | USL-001           | Интерфейс системы должен быть на русском языке                                                                                                                                                          |

## 2. Прогнозируемая нагрузка
### Динамика роста пользователей:

| **Месяц**           | **1 месяц** | **2 месяц** | **3 месяц** | **4 месяц** | **5 месяц** | **6 месяц** | **7 месяц** | **8 месяц** | **9 месяц** | **10 месяц** | **11 месяц** | **12 месяц** |
|---------------------|-------------|-------------|-------------|-------------|-------------|-------------|-------------|-------------|-------------|--------------|--------------|--------------|
| Рост пользователей  | 840 000     | 1 680 000   | 2 520 000   | 3 360 000   | 4 200 000   | 5 040 000   | 5 880 000   | 6 720 000   | 7 560 000   | 8 400 000    | 9 240 000    | 10 000 000   |

Каждый месяц рост на 820 000 пользователей. К году рост достигнет 10 000 000 уникальный пользователей в день.


### Прогноз количества запросов:

| **Среднее число запросов на 1 пользователя** | **avg_requests (в сутки)** | **avg_requests (в секундах)** |
|----------------------------------------------|----------------------------|-------------------------------|
| Добавление постов                            | 5                          | 5,78704E-05                   |
| Реакции на посты                             | 1                          | 1,15741E-05                   |
| Комментарии постов                           | 1                          | 1,15741E-05                   |
| Просмотр ленты постов                        | 3                          | 3,47222E-05                   |
| Поиск популярных мест                        | 1                          | 1,15741E-05                   |
| Просмотр ленты других путешественников       | 3                          | 3,47222E-05                   |
| Подписка ну путешественников                 | 1                          | 3,47222E-05                   |


### Прогноз нагрузки в RPS:

| Бизнес контекст                        | 1 месяц | 2 месяц | 3 месяц | 4 месяц | 5 месяц | 6 месяц | 7 месяц | 8 месяц | 9 месяц | 10 месяц | 11 месяц | 12 месяц |
|----------------------------------------|---------|---------|---------|---------|---------|---------|---------|---------|---------|----------|----------|----------|
| Добавление постов                      | 49      | 97      | 146     | 194     | 243     | 292     | 340     | 389     | 438     | 486      | 535      | 579      |
| Реакции на посты                       | 10      | 19      | 29      | 39      | 49      | 58      | 68      | 78      | 88      | 97       | 107      | 116      |
| Комментарии постов                     | 10      | 19      | 29      | 39      | 49      | 58      | 68      | 78      | 88      | 97       | 107      | 116      |
| Просмотр ленты постов                  | 29      | 58      | 88      | 117     | 146     | 175     | 204     | 233     | 263     | 292      | 321      | 347      |
| Поиск популярных мест                  | 10      | 19      | 29      | 39      | 49      | 58      | 68      | 78      | 88      | 97       | 107      | 116      |
| Просмотр ленты других путешественников | 29      | 58      | 88      | 117     | 146     | 175     | 204     | 233     | 263     | 292      | 321      | 347      |
| Подписка ну путешественников           | 10      | 19      | 29      | 39      | 49      | 58      | 68      | 78      | 88      | 97       | 107      | 116      |

Кол-во уникальный пользователей по динамике * avg_requests (в секундах).


### Прогноз трафика:
Средний размер запроса:

| Контекст | Байты | Килобайты |
|---- |---- |----------|
| Добавление постов (фото) | 200000 | 200      |
| Добавление постов (мета) | 2200 | 2,2      |
| Добавление постов всего | 202200 | 202,2    |
| Реакции на посты | 200 | 0,2      |
| Комментарии постов | 2200 | 2,2      |
| Просмотр ленты постов | 2201 | 2,201    |
| Поиск популярных мест | 2201 | 2,201    |
| Просмотр ленты других путешественников | 2201 | 2,201    |
| Подписка на путешественников | 200 | 0,2      |

Расчет трафика (килобайты в секунду):

| Контекст                               | 1 месяц | 2 месяц | 3 месяц | 4 месяц | 5 месяц | 6 месяц | 7 месяц | 8 месяц | 9 месяц | 10 месяц | 11 месяц | 12 месяц |
|----------------------------------------|---------|---------|---------|---------|---------|---------|---------|---------|---------|----------|----------|----------|
| Добавление постов (фото)               | 9722    | 19444   | 29167   | 38889   | 48611   | 58333   | 68056   | 77778   | 87500   | 97222    | 106944   | 115741   |
| Добавление постов (мета)               | 21      | 43      | 64      | 86      | 107     | 128     | 150     | 171     | 193     | 214      | 235      | 255      |
| Добавление постов (всего)              | 9829    | 19658   | 29488   | 39317   | 49146   | 58975   | 68804   | 78633   | 88463   | 98292    | 108121   | 117014   |
| Реакции на посты                       | 2       | 4       | 6       | 8       | 10      | 12      | 14      | 16      | 18      | 19       | 21       | 23       |
| Комментарии постов                     | 21      | 43      | 64      | 86      | 107     | 128     | 150     | 171     | 193     | 214      | 235      | 255      |
| Просмотр ленты постов                  | 64      | 128     | 193     | 257     | 321     | 385     | 449     | 514     | 578     | 642      | 706      | 764      |
| Поиск популярных мест                  | 21      | 43      | 64      | 86      | 107     | 128     | 150     | 171     | 193     | 214      | 235      | 255      |
| Просмотр ленты других путешественников | 64      | 128     | 193     | 257     | 321     | 385     | 449     | 514     | 578     | 642      | 706      | 764      |
| Подписка на путешественников           | 2       | 4       | 6       | 8       | 10      | 12      | 14      | 16      | 18      | 19       | 21       | 23       |

Расчет трафика (мегабайты в секунду):

| Контекст                               | 1 месяц  | 2 месяц   | 3 месяц   | 4 месяц     | 5 месяц     | 6 месяц     | 7 месяц     | 8 месяц     | 9 месяц   | 10 месяц    | 11 месяц    | 12 месяц    |
|----------------------------------------|----------|-----------|-----------|-------------|-------------|-------------|-------------|-------------|-----------|-------------|-------------|-------------|
| Добавление постов (фото)               | 9,829167 | 19,658333 | 29,487500 | 38,88888889 | 48,61111111 | 58,33333333 | 68,05555556 | 77,77777778 | 87,5      | 97,22222222 | 106,9444444 | 115,7407407 |
| Добавление постов (мета)               | 0,001944 | 0,003889  | 0,005833  | 0,085555556 | 0,106944444 | 0,128333333 | 0,149722222 | 0,171111111 | 0,1925    | 0,213888889 | 0,235277778 | 0,25462963  |
| Добавление постов (всего)              | 0,021389 | 0,042778  | 0,064167  | 39,31666667 | 49,14583333 | 58,975      | 68,80416667 | 78,63333333 | 88,4625   | 98,29166667 | 108,1208333 | 117,0138889 |
| Реакции на посты                       | 0,064196 | 0,128392  | 0,192588  | 0,007777778 | 0,009722222 | 0,011666667 | 0,013611111 | 0,015555556 | 0,0175    | 0,019444444 | 0,021388889 | 0,023148148 |
| Комментарии постов                     | 0,021399 | 0,042797  | 0,064196  | 0,085555556 | 0,106944444 | 0,128333333 | 0,149722222 | 0,171111111 | 0,1925    | 0,213888889 | 0,235277778 | 0,25462963  |
| Просмотр ленты постов                  | 0,064196 | 0,128392  | 0,192588  | 0,256783333 | 0,320979167 | 0,385175    | 0,449370833 | 0,513566667 | 0,5777625 | 0,641958333 | 0,706154167 | 0,764236111 |
| Поиск популярных мест                  | 0,001944 | 0,003889  | 0,005833  | 0,085594444 | 0,106993056 | 0,128391667 | 0,149790278 | 0,171188889 | 0,1925875 | 0,213986111 | 0,235384722 | 0,25474537  |
| Просмотр ленты других путешественников | 0,000000 | 0,000000  | 0,000000  | 0,256783333 | 0,320979167 | 0,385175    | 0,449370833 | 0,513566667 | 0,5777625 | 0,641958333 | 0,706154167 | 0,764236111 |
| Подписка на путешественников           | 0,000000 | 0,000000  | 0,000000  | 0,007777778 | 0,009722222 | 0,011666667 | 0,013611111 | 0,015555556 | 0,0175    | 0,019444444 | 0,021388889 | 0,023148148 |

### Расчет одновременных соединений

| **Месяц**         | **1 месяц** | **2 месяц** | **3 месяц** | **4 месяц** | **5 месяц** | **6 месяц** | **7 месяц** | **8 месяц** | **9 месяц** | **10 месяц** | **11 месяц** | **12 месяц** |
|-------------------|-------------|-------------|-------------|-------------|-------------|-------------|-------------|-------------|-------------|--------------|--------------|--------------|
| Кол-во соединений | 84 000      | 168 000     | 252 000     | 336 000     | 420 000     | 504 000     | 588 000     | 672 000     | 756 000     | 840 000      | 924 000      | 1 000 000    |


## Расчет жесткого диска

Средние параметры:

| Параметр                        | HDD      | SSD (SATA) | SSD (nVME) |
|---------------------------------|----------|------------|------------|
| Объем                           | до 32ТБ  | до 100ТБ   | до 30ТБ    |
| Операции ввода-вывода в секунду | 100      | 1000       | 10000      |
| Пропускная способность          | 100 МБ/с | 500 МБ/с   | 3 ГБ/с     |

**Методика**
Disks_for_capacity = capacity / disk_capacity

Disks_for_throughput = traffic_per_second / disk_throughput

Disks_for_iops = iops / disk_iops

Disks = max(ceil(Disks_for_capacity), ceil(Disks_for_throughput), ceil(Disks_for_iops))

Где:

capacity - суммарный объем данных, которое необходимо хранить

disk_capacity - объем одного диска

traffic_per_second - суммарный трафик на запись/чтение в секунду

disk_throughput - пропускная способность одного диска

iops - суммарное количество запросов в секунду

disk_iops - количество операций ввода-вывод диска в секунду

ceil - функция округления вверх до целого числа

| Контест                      | capacity | disk_capacity | Disks_for_capacity | traffic_per_second | disk_throughput | Disks_for_throughput | iops   | disk_iops | Disks_for_iops |
|------------------------------|----------|---------------|--------------------|--------------------|-----------------|----------------------|--------|-----------|----------------|
| Добавление постов мета       | 8,03     | 8,00          | 1,00               | 117,01             | 500,00          | 0,23                 | 578,70 | 1 000,00  | 0,58           |
| Подписка на путешественников | 0,73     | 1,00          | 0,73               | 0,02               | 500,00          | 0,00                 | 115,74 | 1 000,00  | 0,12           |
| Реакции на посты             | 0,73     | 1,00          | 0,73               | 0,02               | 500,00          | 0,00                 | 115,74 | 1 000,00  | 0,12           |
| Комментарии постов           | 8,03     | 8,00          | 1,00               | 0,25               | 500,00          | 0,00                 | 115,74 | 1 000,00  | 0,12           |

На основании расчета принято решение использовать один SSD (SATA) объемом 16 терабайт.

Расчет производился исходя из показателей на конец первого года, в связи с чем реальное число запросов и трафик будет ниже, поскольку не учитывалась динамика роста трафика, а сразу учитывался конечный объем трафика.

capacity для добавления постов рассчитывалась исходя из мета информации о посте, без учета хранения самой картинки. 

Саму картинку предполагаю хранить на отдельных источниках хранения (возможно S3) или иной вариант. 
